const OPENAI_API_KEY = "sk-proj" // –í—Å—Ç–∞–≤—å—Ç–µ —Å—é–¥–∞ –≤–∞—à OpenAI API –∫–ª—é—á

function –æ—Ç–ø—Ä–∞–≤–∏—Ç—åPDF–°–ì—Ä–∞—Ñ–∏–∫–æ–º–ò–ê–Ω–∞–ª–∏–∑–æ–º() {
  const email = "tehfoxen@gmail.com";
  const ss = SpreadsheetApp.getActiveSpreadsheet();
  const sourceSheet = ss.getSheetByName("–õ–∏—Å—Ç2");

  const data = sourceSheet.getDataRange().getValues();
  const headers = data[0];
  const rows = data.slice(1);

  const idx–ö–∞—Ç–µ–≥–æ—Ä–∏—è = headers.indexOf("–ö–∞—Ç–µ–≥–æ—Ä–∏—è");
  const idx–ü–ª–∞–Ω = headers.indexOf("–ü–ª–∞–Ω");
  const idx–§–∞–∫—Ç = headers.indexOf("–§–∞–∫—Ç");

  // 1. –§–æ—Ä–º–∏—Ä—É–µ–º —Ç–∞–±–ª–∏—Ü—É
  const table = [["–ö–∞—Ç–µ–≥–æ—Ä–∏—è", "–ü–ª–∞–Ω", "–§–∞–∫—Ç", "–û—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ", "% –≤—ã–ø–æ–ª–Ω–µ–Ω–∏—è"]];
  for (let i = 0; i < rows.length; i++) {
    const –∫–∞—Ç = rows[i][idx–ö–∞—Ç–µ–≥–æ—Ä–∏—è];
    const –ø–ª–∞–Ω = rows[i][idx–ü–ª–∞–Ω];
    const —Ñ–∞–∫—Ç = rows[i][idx–§–∞–∫—Ç];
    const –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ = —Ñ–∞–∫—Ç - –ø–ª–∞–Ω;
    const –ø—Ä–æ—Ü–µ–Ω—Ç = –ø–ª–∞–Ω ? ((—Ñ–∞–∫—Ç / –ø–ª–∞–Ω) * 100).toFixed(1) + "%" : "‚Äî";
    table.push([–∫–∞—Ç, –ø–ª–∞–Ω, —Ñ–∞–∫—Ç, –æ—Ç–∫–ª–æ–Ω–µ–Ω–∏–µ, –ø—Ä–æ—Ü–µ–Ω—Ç]);
  }

  // 2. GPT-–∞–Ω–∞–ª–∏–∑
  const csvText = table.map(r => r.join(",")).join("\n");
  const prompt = `
–í–æ—Ç —Ç–∞–±–ª–∏—Ü–∞ —Å –±—é–¥–∂–µ—Ç–æ–º:

${csvText}

–°–¥–µ–ª–∞–π –∫—Ä–∞—Ç–∫–∏–π —É–ø—Ä–∞–≤–ª–µ–Ω—á–µ—Å–∫–∏–π –∞–Ω–∞–ª–∏–∑: –≥–¥–µ –ø–µ—Ä–µ—Ä–∞—Å—Ö–æ–¥, –≥–¥–µ —ç–∫–æ–Ω–æ–º–∏—è, —á—Ç–æ –æ–ø—Ç–∏–º–∏–∑–∏—Ä–æ–≤–∞—Ç—å.
  `;

  const gptResponse = UrlFetchApp.fetch("https://api.openai.com/v1/chat/completions", {
    method: "post",
    contentType: "application/json",
    headers: { Authorization: "Bearer " + OPENAI_API_KEY },
    payload: JSON.stringify({
      model: "gpt-4",
      messages: [{ role: "user", content: prompt }],
      temperature: 0.3
    })
  });

  const gptText = JSON.parse(gptResponse.getContentText()).choices[0].message.content;

  // 3. –°–æ–∑–¥–∞—ë–º –ª–∏—Å—Ç –æ—Ç—á—ë—Ç–∞
  const old = ss.getSheetByName("PDF_–û—Ç—á–µ—Ç");
  if (old) ss.deleteSheet(old);
  const sheet = ss.insertSheet("PDF_–û—Ç—á–µ—Ç");

  // 4. –í—Å—Ç–∞–≤–ª—è–µ–º —Ç–∞–±–ª–∏—Ü—É –≤ A1
  const tableRange = sheet.getRange(1, 1, table.length, table[0].length);
  tableRange.setValues(table);
  tableRange.setBorder(true, true, true, true, true, true);

  // 5. –í—Å—Ç–∞–≤–ª—è–µ–º GPT-–∞–Ω–∞–ª–∏–∑ –≤ –æ–±—ä–µ–¥–∏–Ω—ë–Ω–Ω—ã–µ —Å—Ç—Ä–æ–∫–∏: A8:E8, A9:E9...
  sheet.getRange("A7").setValue("üß† GPT-–ê–Ω–∞–ª–∏–∑:");
  const gptLines = gptText.split('\n').filter(line => line.trim() !== "");
  const startRow = 8;

  for (let i = 0; i < gptLines.length; i++) {
    const row = startRow + i;
    const range = sheet.getRange(`A${row}:E${row}`);
    range.merge();
    range.setValue(gptLines[i]);
    range.setWrap(true);
    range.setBorder(true, true, true, true, true, true);
    sheet.setRowHeight(row, 40);
  }

  // 6. –ì—Ä–∞—Ñ–∏–∫ –≤ G2
  const catRange = sheet.getRange(2, 1, table.length - 1); // –ö–∞—Ç–µ–≥–æ—Ä–∏–∏
  const valRange = sheet.getRange(2, 2, table.length - 1, 2); // –ü–ª–∞–Ω –∏ –§–∞–∫—Ç

  const chart = sheet.newChart()
    .asColumnChart()
    .addRange(catRange)
    .addRange(valRange)
    .setPosition(2, 7, 0, 0) // G2 = column 7
    .setOption("title", "–°—Ä–∞–≤–Ω–µ–Ω–∏–µ: –ü–ª–∞–Ω vs –§–∞–∫—Ç")
    .setOption("legend", { position: "bottom" })
    .build();
  sheet.insertChart(chart);

  const lastRow = startRow + gptLines.length + 20;
  sheet.getRange(`A1:E${lastRow}`).activate();

  // 7. PDF —ç–∫—Å–ø–æ—Ä—Ç
  const exportUrl = `https://docs.google.com/spreadsheets/d/${ss.getId()}/export?exportFormat=pdf&format=pdf&gid=${sheet.getSheetId()}&portrait=false&size=A4&fitw=true&sheetnames=false&printtitle=false&pagenumbers=false&gridlines=false&fzr=false`;
  const token = ScriptApp.getOAuthToken();
  const pdfBlob = UrlFetchApp.fetch(exportUrl, {
    headers: { Authorization: "Bearer " + token }
  }).getBlob().setName("–ë—é–¥–∂–µ—Ç–Ω—ã–π_–æ—Ç—á–µ—Ç.pdf");

  // 8. –û—Ç–ø—Ä–∞–≤–∫–∞ –ø–∏—Å—å–º–∞
  MailApp.sendEmail({
    to: email,
    subject: "üìä PDF-–æ—Ç—á–µ—Ç —Å –∞–Ω–∞–ª–∏–∑–æ–º GPT –∏ –≥—Ä–∞—Ñ–∏–∫–æ–º",
    body: "–í–æ –≤–ª–æ–∂–µ–Ω–∏–∏ ‚Äî PDF-–æ—Ç—á–µ—Ç —Å —Ç–∞–±–ª–∏—Ü–µ–π, –∞–Ω–∞–ª–∏–∑–æ–º –∏ –≥—Ä–∞—Ñ–∏–∫–æ–º.",
    attachments: [pdfBlob]
  });
}
